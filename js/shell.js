// koffee 1.4.0

/*
 0000000  000   000  00000000  000      000    
000       000   000  000       000      000    
0000000   000000000  0000000   000      000    
     000  000   000  000       000      000    
0000000   000   000  00000000  0000000  0000000
 */
var Alias, Chdir, History, Shell, _, args, childp, empty, history, klog, os, post, psTree, ref, slash, valid, wxw,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    indexOf = [].indexOf;

ref = require('kxk'), post = ref.post, history = ref.history, childp = ref.childp, slash = ref.slash, valid = ref.valid, empty = ref.empty, args = ref.args, os = ref.os, klog = ref.klog, _ = ref._;

History = require('./history');

Alias = require('./alias');

Chdir = require('./chdir');

psTree = require('ps-tree');

wxw = require('wxw');

Shell = (function() {
    function Shell(term) {
        this.term = term;
        this.onStdErr = bind(this.onStdErr, this);
        this.onStdOut = bind(this.onStdOut, this);
        this.dequeue = bind(this.dequeue, this);
        this.onDone = bind(this.onDone, this);
        this.onExit = bind(this.onExit, this);
        this.shellCmd = bind(this.shellCmd, this);
        this.executeCmd = bind(this.executeCmd, this);
        this.execute = bind(this.execute, this);
        this.cd = bind(this.cd, this);
        this.editor = this.term.editor;
        this.alias = new Alias(this);
        this.chdir = new Chdir(this);
        this.queue = [];
        this.inputQueue = [];
        this.initPath();
    }

    Shell.prototype.initPath = function() {
        var a, binDir, exeDir, f, j, k, len, len1, pth, ref1, ref2, sep;
        sep = ';';
        if (os.platform() !== 'win32') {
            sep = ':';
        }
        pth = process.env.PATH.split(sep).map(function(s) {
            return slash.path(s);
        });
        ref1 = ['node_modules/.bin', 'bin', '.'];
        for (j = 0, len = ref1.length; j < len; j++) {
            a = ref1[j];
            if (indexOf.call(pth, a) < 0) {
                pth.unshift(a);
            }
        }
        if (slash.isDir('~/s')) {
            ref2 = slash.list('~/s');
            for (k = 0, len1 = ref2.length; k < len1; k++) {
                f = ref2[k];
                if (f.type === 'dir') {
                    exeDir = slash.join(f.file, f.name + "-" + process.platform + "-" + process.arch);
                    if (slash.isDir(exeDir)) {
                        pth.unshift(exeDir);
                        continue;
                    }
                    binDir = slash.join(f.file, "bin");
                    if (slash.isDir(binDir)) {
                        pth.unshift(binDir);
                    }
                }
            }
        }
        return process.env.PATH = pth.map(function(s) {
            return slash.unslash(s);
        }).join(sep);
    };

    Shell.prototype.cd = function(dir) {
        if (!slash.samePath(dir, process.cwd())) {
            this.executeCmd('cd ' + dir);
            return this.editor.focus();
        }
    };

    Shell.prototype.substitute = function(cmd) {
        cmd = this.alias.substitute(cmd);
        cmd = cmd.replace(/\~/g, slash.home());
        return cmd;
    };

    Shell.prototype.execute = function(arg1) {
        var fallback, hsub, ref1, ref2;
        this.cmd = (ref1 = arg1.cmd) != null ? ref1 : null, fallback = (ref2 = arg1.fallback) != null ? ref2 : null;
        if (this.cmd != null) {
            this.cmd;
        } else {
            this.cmd = this.editor.lastLine();
        }
        this.cmd = this.cmd.trim();
        if (this.cmd === '.' && valid(fallback)) {
            this.cmd = fallback;
        }
        if (this.child) {
            this.inputQueue.push(this.cmd);
            this.editor.setInputText('');
            return;
        }
        this.errorText = '';
        if (this.cmd !== (hsub = History.substitute(this.cmd))) {
            this.cmd = hsub;
            this.editor.setInputText(this.cmd);
        }
        this.editor.appendText('');
        this.editor.singleCursorAtEnd();
        if (empty(this.cmd)) {
            this.term.moveInputMeta();
            return;
        }
        this.term.history.shellCmd(this.cmd);
        this.last = {
            cmd: this.cmd,
            cwd: slash.tilde(process.cwd()),
            meta: this.term.insertCmdMeta(this.editor.numLines() - 2, this.cmd)
        };
        if (fallback) {
            this.last.fallback = fallback;
        }
        return this.executeCmd(this.substitute(this.cmd));
    };

    Shell.prototype.executeCmd = function(cmd1) {
        var split;
        this.cmd = cmd1;
        split = this.cmd.split('&&');
        if (split.length > 1) {
            this.cmd = split[0].trim();
            this.queue = this.queue.concat(split.slice(1));
        } else {
            this.cmd = this.cmd.trim();
        }
        if (empty(this.cmd)) {
            this.dequeue();
            return true;
        }
        if (this.alias.onCommand(this.cmd)) {
            this.dequeue();
            return true;
        }
        if (this.chdir.onCommand(this.cmd)) {
            this.dequeue();
            return true;
        }
        return this.shellCmd(this.cmd);
    };

    Shell.prototype.shellCmd = function(cmd1) {
        this.cmd = cmd1;
        process.env.LINES = this.editor.scroll.fullLines;
        process.env.COLUMNS = parseInt(this.editor.layersWidth / this.editor.size.charWidth);
        this.child = childp.exec(this.cmd, {
            shell: 'bash',
            env: process.env,
            cwd: process.cwd()
        });
        this.child.stdout.on('data', this.onStdOut);
        this.child.stderr.on('data', this.onStdErr);
        this.child.on('close', this.onExit);
        return true;
    };

    Shell.prototype.handleCancel = function() {
        this.queue = [];
        this.inputQueue = [];
        if (!this.child) {
            return 'unhandled';
        }
        psTree(this.child.pid, (function(_this) {
            return function(err, children) {
                var arg, j, len, results;
                args = children.map(function(p) {
                    return p.PID;
                });
                args.unshift(_this.child.pid);
                args.reverse();
                _this.child.kill();
                results = [];
                for (j = 0, len = args.length; j < len; j++) {
                    arg = args[j];
                    results.push(wxw('terminate', arg));
                }
                return results;
            };
        })(this));
        return true;
    };

    Shell.prototype.onExit = function(code) {
        var killed;
        killed = this.child.killed;
        delete this.child;
        if (code === 0 || killed) {
            return setImmediate(this.onDone);
        } else if (this.fallback()) {
            return this.dequeue();
        } else {
            this.term.failMeta(this.last.meta);
            if (!/is not recognized/.test(this.errorText)) {
                this.editor.appendOutput('\n' + this.errorText);
            }
            return this.dequeue('fail');
        }
    };

    Shell.prototype.fallback = function() {
        if (this.last.fallback) {
            klog('fallback', this.last.fallback);
            this.enqueue({
                cmd: this.last.fallback,
                update: true
            });
            delete this.last.fallback;
            return true;
        }
    };

    Shell.prototype.onDone = function(lastCode) {
        var info, ref1;
        if (lastCode !== 'fail') {
            if (((ref1 = this.last) != null ? ref1.meta : void 0) != null) {
                info = _.clone(this.last);
                delete info.meta;
                post.emit('cmd', info);
                this.term.succMeta(this.last.meta);
            }
        }
        if (empty(this.queue) && empty(this.inputQueue)) {
            return this.term.pwd();
        } else {
            return this.dequeue();
        }
    };

    Shell.prototype.enqueue = function(arg1) {
        var alias, cmd, front, ref1, ref2, ref3, ref4, update;
        cmd = (ref1 = arg1.cmd) != null ? ref1 : '', front = (ref2 = arg1.front) != null ? ref2 : false, update = (ref3 = arg1.update) != null ? ref3 : false, alias = (ref4 = arg1.alias) != null ? ref4 : false;
        if (update) {
            this.last.orig = this.last.cmd;
            this.last.cmd = cmd;
            if (this.last.meta) {
                this.editor.replaceTextInLine(this.last.meta[0], cmd);
                this.editor.meta.update(this.last.meta);
            }
        }
        if (alias) {
            this.last.alias = cmd;
        }
        cmd = cmd.replace(/\~/g, slash.home());
        if (front) {
            this.queue.unshift(cmd);
        } else {
            this.queue.push(cmd);
        }
        return cmd;
    };

    Shell.prototype.dequeue = function(lastCode) {
        var cmd;
        if (this.queue.length) {
            return this.executeCmd(this.queue.shift());
        } else if (this.inputQueue.length) {
            cmd = this.inputQueue.shift();
            this.editor.setInputText(cmd);
            return this.execute(cmd);
        } else {
            return this.onDone(lastCode);
        }
    };

    Shell.prototype.onStdOut = function(data) {
        if (data.slice(-1)[0] === '\n') {
            data = data.slice(0, +(data.length - 2) + 1 || 9e9);
        }
        this.editor.appendOutput(data);
        return this.editor.singleCursorAtEnd();
    };

    Shell.prototype.onStdErr = function(data) {
        var c, i, path;
        if (data.startsWith('\x1b]0;')) {
            klog('bash prompt');
            data = data.slice(4);
            i = 0;
            c = data[0];
            path = '';
            while (c !== '\x07') {
                path += c;
                c = data[i++];
            }
            klog('path', path);
            return this.editor.appendOutput(data.slice(i));
        } else {
            return this.errorText += data;
        }
    };

    return Shell;

})();

module.exports = Shell;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hlbGwuanMiLCJzb3VyY2VSb290IjoiLiIsInNvdXJjZXMiOlsiIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7QUFBQSxJQUFBLDZHQUFBO0lBQUE7OztBQVFBLE1BQW9FLE9BQUEsQ0FBUSxLQUFSLENBQXBFLEVBQUUsZUFBRixFQUFRLHFCQUFSLEVBQWlCLG1CQUFqQixFQUF5QixpQkFBekIsRUFBZ0MsaUJBQWhDLEVBQXVDLGlCQUF2QyxFQUE4QyxlQUE5QyxFQUFvRCxXQUFwRCxFQUF3RCxlQUF4RCxFQUE4RDs7QUFFOUQsT0FBQSxHQUFVLE9BQUEsQ0FBUSxXQUFSOztBQUNWLEtBQUEsR0FBVSxPQUFBLENBQVEsU0FBUjs7QUFDVixLQUFBLEdBQVUsT0FBQSxDQUFRLFNBQVI7O0FBQ1YsTUFBQSxHQUFVLE9BQUEsQ0FBUSxTQUFSOztBQUNWLEdBQUEsR0FBVSxPQUFBLENBQVEsS0FBUjs7QUFFSjtJQUVDLGVBQUMsSUFBRDtRQUFDLElBQUMsQ0FBQSxPQUFEOzs7Ozs7Ozs7O1FBRUEsSUFBQyxDQUFBLE1BQUQsR0FBVSxJQUFDLENBQUEsSUFBSSxDQUFDO1FBQ2hCLElBQUMsQ0FBQSxLQUFELEdBQVMsSUFBSSxLQUFKLENBQVUsSUFBVjtRQUNULElBQUMsQ0FBQSxLQUFELEdBQVMsSUFBSSxLQUFKLENBQVUsSUFBVjtRQUNULElBQUMsQ0FBQSxLQUFELEdBQVM7UUFDVCxJQUFDLENBQUEsVUFBRCxHQUFjO1FBRWQsSUFBQyxDQUFBLFFBQUQsQ0FBQTtJQVJEOztvQkFnQkgsUUFBQSxHQUFVLFNBQUE7QUFFTixZQUFBO1FBQUEsR0FBQSxHQUFNO1FBSU4sSUFBRyxFQUFFLENBQUMsUUFBSCxDQUFBLENBQUEsS0FBaUIsT0FBcEI7WUFDSSxHQUFBLEdBQU0sSUFEVjs7UUFHQSxHQUFBLEdBQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBakIsQ0FBdUIsR0FBdkIsQ0FBMkIsQ0FBQyxHQUE1QixDQUFnQyxTQUFDLENB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LFFBQVIsRUFMQzs7SUFKQTs7b0JBaUJULFFBQUEsR0FBVSxTQUFDLElBQUQ7UUFFTixJQUFHLElBQUssVUFBRSxDQUFBLENBQUEsQ0FBUCxLQUFZLElBQWY7WUFDSSxJQUFBLEdBQU8sSUFBSyx5Q0FEaEI7O1FBV0EsSUFBQyxDQUFBLE1BQU0sQ0FBQyxZQUFSLENBQXFCLElBQXJCO2VBRUEsSUFBQyxDQUFBLE1BQU0sQ0FBQyxpQkFBUixDQUFBO0lBZk07O29CQWlCVixRQUFBLEdBQVUsU0FBQyxJQUFEO0FBUU4sWUFBQTtRQUFBLElBQUcsSUFBSSxDQUFDLFVBQUwsQ0FBZ0IsU0FBaEIsQ0FBSDtZQUNJLElBQUEsQ0FBSyxhQUFMO1lBQ0EsSUFBQSxHQUFPLElBQUs7WUFDWixDQUFBLEdBQUk7WUFDSixDQUFBLEdBQUksSUFBSyxDQUFBLENBQUE7WUFDVCxJQUFBLEdBQU87QUFDUCxtQkFBTSxDQUFBLEtBQUssTUFBWDtnQkFDSSxJQUFBLElBQVE7Z0JBQ1IsQ0FBQSxHQUFJLElBQUssQ0FBQSxDQUFBLEVBQUE7WUFGYjtZQUdBLElBQUEsQ0FBSyxNQUFMLEVBQVksSUFBWjttQkFDQSxJQUFDLENBQUEsTUFBTSxDQUFDLFlBQVIsQ0FBcUIsSUFBSyxTQUExQixFQVZKO1NBQUEsTUFBQTttQkFZSSxJQUFDLENBQUEsU0FBRCxJQUFjLEtBWmxCOztJQVJNOzs7Ozs7QUFzQmQsTUFBTSxDQUFDLE9BQVAsR0FBaUIiLCJzb3VyY2VzQ29udGVudCI6WyIjIyNcbiAwMDAwMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwICAwMDAgICAgICAwMDAgICAgXG4wMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgICAgMDAwICAgIFxuMDAwMDAwMCAgIDAwMDAwMDAwMCAgMDAwMDAwMCAgIDAwMCAgICAgIDAwMCAgICBcbiAgICAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAgICAwMDAgICAgXG4wMDAwMDAwICAgMDAwICAgMDAwICAwMDAwMDAwMCAgMDAwMDAwMCAgMDAwMDAwMFxuIyMjXG5cbnsgcG9zdCwgaGlzdG9yeSwgY2hpbGRwLCBzbGFzaCwgdmFsaWQsIGVtcHR5LCBhcmdzLCBvcywga2xvZywgXyB9ID0gcmVxdWlyZSAna3hrJ1xuXG5IaXN0b3J5ID0gcmVxdWlyZSAnLi9oaXN0b3J5J1xuQWxpYXMgICA9IHJlcXVpcmUgJy4vYWxpYXMnXG5DaGRpciAgID0gcmVxdWlyZSAnLi9jaGRpcidcbnBzVHJlZSAgPSByZXF1aXJlICdwcy10cmVlJ1xud3h3ICAgICA9IHJlcXVpcmUgJ3d4dydcblxuY2xhc3MgU2hlbGxcblxuICAgIEA6IChAdGVybSkgLT5cbiAgICAgICAgXG4gICAgICAgIEBlZGl0b3IgPSBAdGVybS5lZGl0b3JcbiAgICAgICAgQGFsaWFzID0gbmV3IEFsaWFzIEBcbiAgICAgICAgQGNoZGlyID0gbmV3IENoZGlyIEBcbiAgICAgICAgQHF1ZXVlID0gW11cbiAgICAgICAgQGlucHV0UXVldWUgPSBbXVxuICAgIFxuICAgICAgICBAaW5pdFBhdGgoKVxuICAgIFxuICAgICMgMDAwMDAwMDAgICAgMDAwMDAwMCAgIDAwMDAwMDAwMCAgMDAwICAgMDAwICBcbiAgICAjIDAwMCAgIDAwMCAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgIDAwMCAgXG4gICAgIyAwMDAwMDAwMCAgIDAwMDAwMDAwMCAgICAgMDAwICAgICAwMDAwMDAwMDAgIFxuICAgICMgMDAwICAgICAgICAwMDAgICAwMDAgICAgIDAwMCAgICAgMDAwICAgMDAwICBcbiAgICAjIDAwMCAgICAgICAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgIDAwMCAgXG4gICAgXG4gICAgaW5pdFBhdGg6IC0+XG4gICAgICAgIFxuICAgICAgICBzZXAgPSAnOydcbiAgICAgICAgXG4gICAgICAgICMga2xvZyAnU0hFTEwnIHByb2Nlc3MuZW52LlNIRUxMXG4gICAgICAgIFxuICAgICAgICBpZiBvcy5wbGF0Zm9ybSgpICE9ICd3aW4zMicgI29yIHByb2Nlc3MuZW52LlNIRUxMXG4gICAgICAgICAgICBzZXAgPSAnOicgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgIHB0aCA9IHByb2Nlc3MuZW52LlBBVEguc3BsaXQoc2VwKS5tYXAgKHMpIC0+IHNsYXNoLnBhdGggc1xuXG4gICAgICAgIGZvciBhIGluIFsnbm9kZV9tb2R1bGVzLy5iaW4nICdiaW4nICcuJ11cbiAgICAgICAgICAgIGlmIGEgbm90IGluIHB0aFxuICAgICAgICAgICAgICAgICMga2xvZyBcImFkZCB0byBQQVRIICN7YX1cIlxuICAgICAgICAgICAgICAgIHB0aC51bnNoaWZ0IGFcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgaWYgc2xhc2guaXNEaXIgJ34vcydcbiAgICAgICAgICAgIGZvciBmIGluIHNsYXNoLmxpc3QgJ34vcydcbiAgICAgICAgICAgICAgICBpZiBmLnR5cGUgPT0gJ2RpcidcbiAgICAgICAgICAgICAgICAgICAgZXhlRGlyID0gc2xhc2guam9pbiBmLmZpbGUsIFwiI3tmLm5hbWV9LSN7cHJvY2Vzcy5wbGF0Zm9ybX0tI3twcm9jZXNzLmFyY2h9XCJcbiAgICAgICAgICAgICAgICAgICAgaWYgc2xhc2guaXNEaXIgZXhlRGlyXG4gICAgICAgICAgICAgICAgICAgICAgICAjIGtsb2cgXCJhZGQgZXhlIGRpclwiIGV4ZURpclxuICAgICAgICAgICAgICAgICAgICAgICAgcHRoLnVuc2hpZnQgZXhlRGlyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZVxuICAgICAgICAgICAgICAgICAgICBiaW5EaXIgPSBzbGFzaC5qb2luIGYuZmlsZSwgXCJiaW5cIlxuICAgICAgICAgICAgICAgICAgICBpZiBzbGFzaC5pc0RpciBiaW5EaXJcbiAgICAgICAgICAgICAgICAgICAgICAgICMga2xvZyBcImFkZCBiaW4gZGlyXCIgYmluRGlyXG4gICAgICAgICAgICAgICAgICAgICAgICBwdGgudW5zaGlmdCBiaW5EaXJcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgcHJvY2Vzcy5lbnYuUEFUSCA9IHB0aC5tYXAoKHMpIC0+IHNsYXNoLnVuc2xhc2ggcykuam9pbiBzZXBcbiAgICAgICAgXG4gICAgICAgICMga2xvZyAnUEFUSCcgcHJvY2Vzcy5lbnYuUEFUSFxuICAgICAgICBcbiAgICBjZDogKGRpcikgPT5cbiAgICAgICAgXG4gICAgICAgIGlmIG5vdCBzbGFzaC5zYW1lUGF0aCBkaXIsIHByb2Nlc3MuY3dkKClcbiAgICAgICAgICAgIEBleGVjdXRlQ21kICdjZCAnICsgZGlyXG4gICAgICAgICAgICBAZWRpdG9yLmZvY3VzKClcbiAgICAgICAgXG4gICAgc3Vic3RpdHV0ZTogKGNtZCkgLT5cbiAgICAgICAgXG4gICAgICAgIGNtZCA9IEBhbGlhcy5zdWJzdGl0dXRlIGNtZFxuICAgICAgICBjbWQgPSBjbWQucmVwbGFjZSAvXFx+L2csIHNsYXNoLmhvbWUoKVxuICAgICAgICBjbWRcbiAgICAgICAgICAgIFxuICAgICMgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgICAwMDAwMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwMCAgMDAwMDAwMDAgIFxuICAgICMgMDAwICAgICAgICAwMDAgMDAwICAgMDAwICAgICAgIDAwMCAgICAgICAwMDAgICAwMDAgICAgIDAwMCAgICAgMDAwICAgICAgIFxuICAgICMgMDAwMDAwMCAgICAgMDAwMDAgICAgMDAwMDAwMCAgIDAwMCAgICAgICAwMDAgICAwMDAgICAgIDAwMCAgICAgMDAwMDAwMCAgIFxuICAgICMgMDAwICAgICAgICAwMDAgMDAwICAgMDAwICAgICAgIDAwMCAgICAgICAwMDAgICAwMDAgICAgIDAwMCAgICAgMDAwICAgICAgIFxuICAgICMgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgICAwMDAwMDAwICAgMDAwMDAwMCAgICAgIDAwMCAgICAgMDAwMDAwMDAgIFxuICAgIFxuICAgIGV4ZWN1dGU6IChAY21kOiwgZmFsbGJhY2s6KSA9PlxuICAgIFxuICAgICAgICBAY21kID89IEBlZGl0b3IubGFzdExpbmUoKVxuICAgICAgICBAY21kID0gQGNtZC50cmltKClcbiAgICBcbiAgICAgICAgaWYgQGNtZCA9PSAnLicgYW5kIHZhbGlkIGZhbGxiYWNrXG4gICAgICAgICAgICBAY21kID0gZmFsbGJhY2tcbiAgICAgICAgXG4gICAgICAgIGlmIEBjaGlsZFxuICAgICAgICAgICAgQGlucHV0UXVldWUucHVzaCBAY21kXG4gICAgICAgICAgICBAZWRpdG9yLnNldElucHV0VGV4dCAnJ1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIFxuICAgICAgICBAZXJyb3JUZXh0ID0gJydcbiAgICAgICAgXG4gICAgICAgIGlmIEBjbWQgIT0gaHN1YiA9IEhpc3Rvcnkuc3Vic3RpdHV0ZSBAY21kXG4gICAgICAgICAgICBAY21kID0gaHN1YlxuICAgICAgICAgICAgQGVkaXRvci5zZXRJbnB1dFRleHQgQGNtZFxuICAgICAgICBcbiAgICAgICAgQGVkaXRvci5hcHBlbmRUZXh0ICcnXG4gICAgICAgIEBlZGl0b3Iuc2luZ2xlQ3Vyc29yQXRFbmQoKVxuICAgICAgICAgICAgXG4gICAgICAgIGlmIGVtcHR5IEBjbWQgXG4gICAgICAgICAgICBAdGVybS5tb3ZlSW5wdXRNZXRhKClcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICBcbiAgICAgICAgQHRlcm0uaGlzdG9yeS5zaGVsbENtZCBAY21kICMgcmVzZXQgaGlzdG9yeSBwb2ludGVyIHRvIGxhc3RcblxuICAgICAgICBAbGFzdCA9XG4gICAgICAgICAgICBjbWQ6ICAgICAgQGNtZFxuICAgICAgICAgICAgY3dkOiAgICAgIHNsYXNoLnRpbGRlIHByb2Nlc3MuY3dkKClcbiAgICAgICAgICAgIG1ldGE6ICAgICBAdGVybS5pbnNlcnRDbWRNZXRhIEBlZGl0b3IubnVtTGluZXMoKS0yIEBjbWRcbiAgICAgICAgICAgIFxuICAgICAgICBAbGFzdC5mYWxsYmFjayA9IGZhbGxiYWNrIGlmIGZhbGxiYWNrXG4gICAgICAgIFxuICAgICAgICBAZXhlY3V0ZUNtZCBAc3Vic3RpdHV0ZSBAY21kXG4gICAgICAgICAgICAgICAgXG4gICAgIyAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgICAgICAgIDAwMDAwMDAgIDAwICAgICAwMCAgMDAwMDAwMCAgICBcbiAgICAjIDAwMCAgICAgICAgMDAwIDAwMCAgIDAwMCAgICAgICAwMDAgICAgICAgICAgICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIFxuICAgICMgMDAwMDAwMCAgICAgMDAwMDAgICAgMDAwMDAwMCAgIDAwMCAgICAgICAgICAgIDAwMCAgICAgICAwMDAwMDAwMDAgIDAwMCAgIDAwMCAgXG4gICAgIyAwMDAgICAgICAgIDAwMCAwMDAgICAwMDAgICAgICAgMDAwICAgICAgICAgICAgMDAwICAgICAgIDAwMCAwIDAwMCAgMDAwICAgMDAwICBcbiAgICAjIDAwMDAwMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwICAgMDAwMDAwMCAgICAgICAgMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwICAgIFxuICAgIFxuICAgIGV4ZWN1dGVDbWQ6IChAY21kKSA9PlxuXG4gICAgICAgIHNwbGl0ID0gQGNtZC5zcGxpdCAnJiYnXG4gICAgICAgIGlmIHNwbGl0Lmxlbmd0aCA+IDFcbiAgICAgICAgICAgIEBjbWQgPSBzcGxpdFswXS50cmltKClcbiAgICAgICAgICAgIEBxdWV1ZSA9IEBxdWV1ZS5jb25jYXQgc3BsaXRbMS4uXVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICBAY21kID0gQGNtZC50cmltKClcbiAgICAgICAgXG4gICAgICAgIGlmIGVtcHR5IEBjbWRcbiAgICAgICAgICAgIEBkZXF1ZXVlKClcbiAgICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIFxuICAgICAgICBpZiBAYWxpYXMub25Db21tYW5kIEBjbWRcbiAgICAgICAgICAgIEBkZXF1ZXVlKClcbiAgICAgICAgICAgIHJldHVybiB0cnVlXG5cbiAgICAgICAgaWYgQGNoZGlyLm9uQ29tbWFuZCBAY21kXG4gICAgICAgICAgICBAZGVxdWV1ZSgpXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICAgICAgXG4gICAgICAgICMga2xvZyAnc2hlbGxDbWQnIEBjbWRcbiAgICAgICAgQHNoZWxsQ21kIEBjbWRcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgIyAgMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgMDAwICAgICAgMDAwICAgICAgICAgICAwMDAwMDAwICAwMCAgICAgMDAgIDAwMDAwMDAgICAgXG4gICAgIyAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgICAgMDAwICAgICAgICAgIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgXG4gICAgIyAwMDAwMDAwICAgMDAwMDAwMDAwICAwMDAwMDAwICAgMDAwICAgICAgMDAwICAgICAgICAgIDAwMCAgICAgICAwMDAwMDAwMDAgIDAwMCAgIDAwMCAgXG4gICAgIyAgICAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgICAgMDAwICAgICAgICAgIDAwMCAgICAgICAwMDAgMCAwMDAgIDAwMCAgIDAwMCAgXG4gICAgIyAwMDAwMDAwICAgMDAwICAgMDAwICAwMDAwMDAwMCAgMDAwMDAwMCAgMDAwMDAwMCAgICAgICAwMDAwMDAwICAwMDAgICAwMDAgIDAwMDAwMDAgICAgXG4gICAgXG4gICAgc2hlbGxDbWQ6IChAY21kKSA9PlxuICAgICAgICAgICAgXG4gICAgICAgIHByb2Nlc3MuZW52LkxJTkVTICAgPSBAZWRpdG9yLnNjcm9sbC5mdWxsTGluZXNcbiAgICAgICAgcHJvY2Vzcy5lbnYuQ09MVU1OUyA9IHBhcnNlSW50IEBlZGl0b3IubGF5ZXJzV2lkdGggLyBAZWRpdG9yLnNpemUuY2hhcldpZHRoXG4gICAgICAgIFxuICAgICAgICBAY2hpbGQgPSBjaGlsZHAuZXhlYyBAY21kLCBzaGVsbDonYmFzaCcgZW52OnByb2Nlc3MuZW52LCBjd2Q6cHJvY2Vzcy5jd2QoKSAgICBcbiAgICAgICAgQGNoaWxkLnN0ZG91dC5vbiAnZGF0YScgIEBvblN0ZE91dFxuICAgICAgICBAY2hpbGQuc3RkZXJyLm9uICdkYXRhJyAgQG9uU3RkRXJyXG4gICAgICAgIEBjaGlsZC5vbiAgICAgICAgJ2Nsb3NlJyBAb25FeGl0XG4gICAgICAgICAgICBcbiAgICAgICAgdHJ1ZVxuICAgICAgICBcbiAgICAjICAwMDAwMDAwICAgMDAwMDAwMCAgIDAwMCAgIDAwMCAgIDAwMDAwMDAgIDAwMDAwMDAwICAwMDAgICAgICBcbiAgICAjIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMDAgIDAwMCAgMDAwICAgICAgIDAwMCAgICAgICAwMDAgICAgICBcbiAgICAjIDAwMCAgICAgICAwMDAwMDAwMDAgIDAwMCAwIDAwMCAgMDAwICAgICAgIDAwMDAwMDAgICAwMDAgICAgICBcbiAgICAjIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgMDAwMCAgMDAwICAgICAgIDAwMCAgICAgICAwMDAgICAgICBcbiAgICAjICAwMDAwMDAwICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgIDAwMDAwMDAgIDAwMDAwMDAwICAwMDAwMDAwICBcbiAgICBcbiAgICBoYW5kbGVDYW5jZWw6IC0+XG4gICAgICAgIFxuICAgICAgICBAcXVldWUgPSBbXVxuICAgICAgICBAaW5wdXRRdWV1ZSA9IFtdXG4gICAgICAgIFxuICAgICAgICByZXR1cm4gJ3VuaGFuZGxlZCcgaWYgbm90IEBjaGlsZFxuICAgICAgICBcbiAgICAgICAgcHNUcmVlIEBjaGlsZC5waWQsIChlcnIsIGNoaWxkcmVuKSA9PlxuICAgICAgICAgICAgXG4gICAgICAgICAgICBhcmdzID0gY2hpbGRyZW4ubWFwIChwKSAtPiBwLlBJRFxuICAgICAgICAgICAgYXJncy51bnNoaWZ0IEBjaGlsZC5waWRcbiAgICAgICAgICAgIGFyZ3MucmV2ZXJzZSgpXG4gICAgICAgICAgICBAY2hpbGQua2lsbCgpXG4gICAgICAgICAgICBmb3IgYXJnIGluIGFyZ3NcbiAgICAgICAgICAgICAgICB3eHcgJ3Rlcm1pbmF0ZScgYXJnXG4gICAgICAgIHRydWVcbiAgICAgICAgXG4gICAgIyAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAgIDAwMDAwMDAwMCAgXG4gICAgIyAwMDAgICAgICAgIDAwMCAwMDAgICAwMDAgICAgIDAwMCAgICAgXG4gICAgIyAwMDAwMDAwICAgICAwMDAwMCAgICAwMDAgICAgIDAwMCAgICAgXG4gICAgIyAwMDAgICAgICAgIDAwMCAwMDAgICAwMDAgICAgIDAwMCAgICAgXG4gICAgIyAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAgICAgIDAwMCAgICAgXG4gICAgICAgIFxuICAgIG9uRXhpdDogKGNvZGUpID0+XG5cbiAgICAgICAga2lsbGVkID0gQGNoaWxkLmtpbGxlZFxuICAgICAgICBkZWxldGUgQGNoaWxkXG4gICAgICAgIFxuICAgICAgICBpZiBjb2RlID09IDAgb3Iga2lsbGVkIFxuICAgICAgICAgICAgc2V0SW1tZWRpYXRlIEBvbkRvbmVcbiAgICAgICAgZWxzZSBpZiBAZmFsbGJhY2soKVxuICAgICAgICAgICAgQGRlcXVldWUoKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICBAdGVybS5mYWlsTWV0YSBAbGFzdC5tZXRhXG4gICAgICAgICAgICBpZiBub3QgL2lzIG5vdCByZWNvZ25pemVkLy50ZXN0IEBlcnJvclRleHRcbiAgICAgICAgICAgICAgICBAZWRpdG9yLmFwcGVuZE91dHB1dCAnXFxuJytAZXJyb3JUZXh0XG4gICAgICAgICAgICBAZGVxdWV1ZSAnZmFpbCdcbiAgICAgICAgICBcbiAgICAjIDAwMDAwMDAwICAgMDAwMDAwMCAgIDAwMCAgICAgIDAwMCAgICAgIDAwMDAwMDAgICAgIDAwMDAwMDAgICAgMDAwMDAwMCAgMDAwICAgMDAwICBcbiAgICAjIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgICAgIDAwMCAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAwMDAgICBcbiAgICAjIDAwMDAwMCAgICAwMDAwMDAwMDAgIDAwMCAgICAgIDAwMCAgICAgIDAwMDAwMDAgICAgMDAwMDAwMDAwICAwMDAgICAgICAgMDAwMDAwMCAgICBcbiAgICAjIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgICAgIDAwMCAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAwMDAgICBcbiAgICAjIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMDAwMDAgIDAwMDAwMDAgIDAwMDAwMDAgICAgMDAwICAgMDAwICAgMDAwMDAwMCAgMDAwICAgMDAwICBcbiAgICBcbiAgICBmYWxsYmFjazogLT5cbiAgICAgICAgXG4gICAgICAgIGlmIEBsYXN0LmZhbGxiYWNrXG4gICAgICAgICAgICBrbG9nICdmYWxsYmFjaycgQGxhc3QuZmFsbGJhY2tcbiAgICAgICAgICAgIEBlbnF1ZXVlIGNtZDpAbGFzdC5mYWxsYmFjaywgdXBkYXRlOnRydWVcbiAgICAgICAgICAgIGRlbGV0ZSBAbGFzdC5mYWxsYmFja1xuICAgICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgXG4gICAgIyAwMDAwMDAwICAgICAwMDAwMDAwICAgMDAwICAgMDAwICAwMDAwMDAwMCAgXG4gICAgIyAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwMCAgMDAwICAwMDAgICAgICAgXG4gICAgIyAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwIDAgMDAwICAwMDAwMDAwICAgXG4gICAgIyAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAwMDAwICAwMDAgICAgICAgXG4gICAgIyAwMDAwMDAwICAgICAwMDAwMDAwICAgMDAwICAgMDAwICAwMDAwMDAwMCAgXG4gICAgXG4gICAgb25Eb25lOiAobGFzdENvZGUpID0+XG5cbiAgICAgICAgaWYgbGFzdENvZGUgIT0gJ2ZhaWwnIFxuICAgICAgICAgICAgaWYgQGxhc3Q/Lm1ldGE/XG4gICAgICAgICAgICAgICAgaW5mbyA9IF8uY2xvbmUgQGxhc3RcbiAgICAgICAgICAgICAgICBkZWxldGUgaW5mby5tZXRhXG4gICAgICAgICAgICAgICAgcG9zdC5lbWl0ICdjbWQnIGluZm8gIyBpbnNlcnQgaW50byBnbG9iYWwgaGlzdG9yeSBhbmQgYnJhaW5cbiAgICAgICAgICAgICAgICBAdGVybS5zdWNjTWV0YSBAbGFzdC5tZXRhXG4gICAgICAgIGlmIGVtcHR5KEBxdWV1ZSkgYW5kIGVtcHR5KEBpbnB1dFF1ZXVlKVxuICAgICAgICAgICAgQHRlcm0ucHdkKClcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgQGRlcXVldWUoKVxuICAgICAgICAgICBcbiAgICAjIDAwMDAwMDAwICAwMDAgICAwMDAgICAwMDAwMDAwICAgMDAwICAgMDAwICAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgXG4gICAgIyAwMDAgICAgICAgMDAwMCAgMDAwICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgICAgIFxuICAgICMgMDAwMDAwMCAgIDAwMCAwIDAwMCAgMDAwIDAwIDAwICAwMDAgICAwMDAgIDAwMDAwMDAgICAwMDAgICAwMDAgIDAwMDAwMDAgICBcbiAgICAjIDAwMCAgICAgICAwMDAgIDAwMDAgIDAwMCAwMDAwICAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAgXG4gICAgIyAwMDAwMDAwMCAgMDAwICAgMDAwICAgMDAwMDAgMDAgICAwMDAwMDAwICAgMDAwMDAwMDAgICAwMDAwMDAwICAgMDAwMDAwMDAgIFxuICAgIFxuICAgIGVucXVldWU6IChjbWQ6JycgZnJvbnQ6ZmFsc2UgdXBkYXRlOmZhbHNlIGFsaWFzOmZhbHNlKSAtPiBcbiAgICBcbiAgICAgICAgaWYgdXBkYXRlXG4gICAgICAgICAgICBAbGFzdC5vcmlnID0gQGxhc3QuY21kXG4gICAgICAgICAgICBAbGFzdC5jbWQgPSBjbWRcbiAgICAgICAgICAgIGlmIEBsYXN0Lm1ldGFcbiAgICAgICAgICAgICAgICBAZWRpdG9yLnJlcGxhY2VUZXh0SW5MaW5lIEBsYXN0Lm1ldGFbMF0sIGNtZFxuICAgICAgICAgICAgICAgIEBlZGl0b3IubWV0YS51cGRhdGUgQGxhc3QubWV0YVxuICAgICAgICAgICAgXG4gICAgICAgIGlmIGFsaWFzXG4gICAgICAgICAgICBAbGFzdC5hbGlhcyA9IGNtZFxuICAgICAgICAgICAgICAgIFxuICAgICAgICBjbWQgPSBjbWQucmVwbGFjZSAvXFx+L2csIHNsYXNoLmhvbWUoKVxuICAgICAgICBcbiAgICAgICAgaWYgZnJvbnRcbiAgICAgICAgICAgIEBxdWV1ZS51bnNoaWZ0IGNtZFxuICAgICAgICBlbHNlXG4gICAgICAgICAgICBAcXVldWUucHVzaCBjbWRcbiAgICAgICAgY21kXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICMgMDAwMDAwMCAgICAwMDAwMDAwMCAgIDAwMDAwMDAgICAwMDAgICAwMDAgIDAwMDAwMDAwICAwMDAgICAwMDAgIDAwMDAwMDAwICBcbiAgICAjIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAgXG4gICAgIyAwMDAgICAwMDAgIDAwMDAwMDAgICAwMDAgMDAgMDAgIDAwMCAgIDAwMCAgMDAwMDAwMCAgIDAwMCAgIDAwMCAgMDAwMDAwMCAgIFxuICAgICMgMDAwICAgMDAwICAwMDAgICAgICAgMDAwIDAwMDAgICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgICAgICBcbiAgICAjIDAwMDAwMDAgICAgMDAwMDAwMDAgICAwMDAwMCAwMCAgIDAwMDAwMDAgICAwMDAwMDAwMCAgIDAwMDAwMDAgICAwMDAwMDAwMCAgXG4gICAgXG4gICAgZGVxdWV1ZTogKGxhc3RDb2RlKSA9PlxuIFxuICAgICAgICBpZiBAcXVldWUubGVuZ3RoXG4gICAgICAgICAgICBAZXhlY3V0ZUNtZCBAcXVldWUuc2hpZnQoKVxuICAgICAgICBlbHNlIGlmIEBpbnB1dFF1ZXVlLmxlbmd0aFxuICAgICAgICAgICAgY21kID0gQGlucHV0UXVldWUuc2hpZnQoKVxuICAgICAgICAgICAgQGVkaXRvci5zZXRJbnB1dFRleHQgY21kXG4gICAgICAgICAgICBAZXhlY3V0ZSBjbWRcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgQG9uRG9uZSBsYXN0Q29kZVxuICAgICAgICBcbiAgICAjICAwMDAwMDAwICAwMDAwMDAwMDAgIDAwMDAwMDAgICAgXG4gICAgIyAwMDAgICAgICAgICAgMDAwICAgICAwMDAgICAwMDAgIFxuICAgICMgMDAwMDAwMCAgICAgIDAwMCAgICAgMDAwICAgMDAwICBcbiAgICAjICAgICAgMDAwICAgICAwMDAgICAgIDAwMCAgIDAwMCAgXG4gICAgIyAwMDAwMDAwICAgICAgMDAwICAgICAwMDAwMDAwICAgIFxuICAgIFxuICAgIG9uU3RkT3V0OiAoZGF0YSkgPT5cbiAgICAgICAgXG4gICAgICAgIGlmIGRhdGFbLTFdID09ICdcXG4nXG4gICAgICAgICAgICBkYXRhID0gZGF0YVswLi5kYXRhLmxlbmd0aC0yXVxuXG4gICAgICAgICMgZGF0YSA9IGRhdGEucmVwbGFjZSAvKFxceDFCXFxbXFw/MjVbaGxdKXwoXFx4MGEpL2csICcnXG4gICAgICAgICAgICBcbiAgICAgICAgIyBidWYgPSBCdWZmZXIuZnJvbSBkYXRhLCAndXRmOCdcbiAgICAgICAgIyBmb3IgYyBpbiBidWZcbiAgICAgICAgICAgICMga2xvZyBcIiN7a3N0ci5wYWQgYywgM30gMHgje2MudG9TdHJpbmcoMTYpfSAnI3tTdHJpbmcuZnJvbUNoYXJDb2RlKGMpfSdcIlxuICAgICAgICAgICAgXG4gICAgICAgICMga2xvZyAnPT09PT09PT09PT09PT09PScgZGF0YVxuICAgICAgICAgICAgXG4gICAgICAgIEBlZGl0b3IuYXBwZW5kT3V0cHV0IGRhdGFcbiAgICAgICAgIyBAZWRpdG9yLnNldElucHV0VGV4dCBAZWRpdG9yLmxhc3RMaW5lKCkrZGF0YVxuICAgICAgICBAZWRpdG9yLnNpbmdsZUN1cnNvckF0RW5kKClcblxuICAgIG9uU3RkRXJyOiAoZGF0YSkgPT5cblxuICAgICAgICAjIGtsb2cgJy0tLS0tLS0tLS0tLS0tLS0nIGRhdGFcbiAgICAgICAgXG4gICAgICAgICMgYnVmID0gQnVmZmVyLmZyb20gZGF0YSwgJ3V0ZjgnXG4gICAgICAgICMgZm9yIGMgaW4gYnVmXG4gICAgICAgICAgICAjIGtsb2cgXCIje2tzdHIucGFkIGMsIDN9IDB4I3tjLnRvU3RyaW5nKDE2KX0gJyN7U3RyaW5nLmZyb21DaGFyQ29kZShjKX0nXCJcbiAgICAgICAgXG4gICAgICAgIGlmIGRhdGEuc3RhcnRzV2l0aCAnXFx4MWJdMDsnXG4gICAgICAgICAgICBrbG9nICdiYXNoIHByb21wdCdcbiAgICAgICAgICAgIGRhdGEgPSBkYXRhWzQuLl1cbiAgICAgICAgICAgIGkgPSAwXG4gICAgICAgICAgICBjID0gZGF0YVswXVxuICAgICAgICAgICAgcGF0aCA9ICcnXG4gICAgICAgICAgICB3aGlsZSBjICE9ICdcXHgwNydcbiAgICAgICAgICAgICAgICBwYXRoICs9IGNcbiAgICAgICAgICAgICAgICBjID0gZGF0YVtpKytdXG4gICAgICAgICAgICBrbG9nICdwYXRoJyBwYXRoXG4gICAgICAgICAgICBAZWRpdG9yLmFwcGVuZE91dHB1dCBkYXRhW2kuLl1cbiAgICAgICAgZWxzZSAgIFxuICAgICAgICAgICAgQGVycm9yVGV4dCArPSBkYXRhXG4gICAgICAgIFxubW9kdWxlLmV4cG9ydHMgPSBTaGVsbFxuIl19
//# sourceURL=../coffee/shell.coffee