// koffee 1.4.0

/*
 0000000  000   000  00000000  000      000    
000       000   000  000       000      000    
0000000   000000000  0000000   000      000    
     000  000   000  000       000      000    
0000000   000   000  00000000  0000000  0000000
 */
var Alias, Chdir, History, Shell, args, childp, empty, history, kerror, klog, post, psTree, ref, slash, wxw,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

ref = require('kxk'), post = ref.post, history = ref.history, childp = ref.childp, kerror = ref.kerror, slash = ref.slash, empty = ref.empty, args = ref.args, klog = ref.klog;

History = require('./history');

Alias = require('./alias');

Chdir = require('./chdir');

psTree = require('ps-tree');

wxw = require('wxw');

Shell = (function() {
    function Shell(term) {
        this.term = term;
        this.onStdErr = bind(this.onStdErr, this);
        this.onStdOut = bind(this.onStdOut, this);
        this.dequeue = bind(this.dequeue, this);
        this.onDone = bind(this.onDone, this);
        this.onExit = bind(this.onExit, this);
        this.shellCmd = bind(this.shellCmd, this);
        this.executeCmd = bind(this.executeCmd, this);
        this.execute = bind(this.execute, this);
        this.cd = bind(this.cd, this);
        this.editor = this.term.editor;
        this.alias = new Alias(this);
        this.chdir = new Chdir(this);
        this.queue = [];
        this.inputQueue = [];
    }

    Shell.prototype.cd = function(dir) {
        if (!slash.samePath(dir, process.cwd())) {
            this.executeCmd('cd ' + dir);
            return this.editor.focus();
        }
    };

    Shell.prototype.substitute = function(cmd) {
        cmd = this.alias.substitute(cmd);
        cmd = cmd.replace(/\~/g, slash.home());
        return cmd;
    };

    Shell.prototype.execute = function(arg1) {
        var fallback, hsub, ref1, ref2;
        this.cmd = (ref1 = arg1.cmd) != null ? ref1 : null, fallback = (ref2 = arg1.fallback) != null ? ref2 : null;
        if (this.cmd != null) {
            this.cmd;
        } else {
            this.cmd = this.editor.lastLine();
        }
        this.cmd = this.cmd.trim();
        if (this.child) {
            this.inputQueue.push(this.cmd);
            this.editor.setInputText('');
            return;
        }
        this.errorText = '';
        if (this.cmd !== (hsub = History.substitute(this.cmd))) {
            this.cmd = hsub;
            this.editor.setInputText(this.cmd);
        }
        this.editor.appendText('');
        this.editor.singleCursorAtEnd();
        if (empty(this.cmd)) {
            return;
        }
        this.term.history.shellCmd(this.cmd);
        this.lastMeta = this.term.insertCmdMeta(this.editor.numLines() - 2, this.cmd);
        this.lastMeta.cmd = this.cmd;
        this.lastMeta.cwd = process.cwd();
        this.lastMeta.fallback = fallback;
        return this.executeCmd(this.substitute(this.cmd));
    };

    Shell.prototype.executeCmd = function(cmd1) {
        var split;
        this.cmd = cmd1;
        split = this.cmd.split('&&');
        if (split.length > 1) {
            this.cmd = split[0].trim();
            this.queue = this.queue.concat(split.slice(1));
        } else {
            this.cmd = this.cmd.trim();
        }
        if (empty(this.cmd)) {
            this.dequeue();
            return true;
        }
        if (this.alias.onCommand(this.cmd)) {
            this.dequeue();
            return true;
        }
        if (this.chdir.onCommand(this.cmd)) {
            this.dequeue();
            return true;
        }
        return this.shellCmd(this.cmd);
    };

    Shell.prototype.shellCmd = function(cmd1) {
        var cmd, currentCommand, firstChild, i, j, opt, pipe, previousChild, ref1, split;
        this.cmd = cmd1;
        split = this.cmd.split('|');
        if (split.length > 1) {
            pipe = function(child, stdout, stderr) {
                child.stdin.on('error', function(err) {
                    return stderr.write('stdin error' + err + '\n');
                });
                child.stderr.on('data', function(data) {
                    if (!/^execvp\(\)/.test(data)) {
                        return stderr.write(data);
                    }
                });
                child.stdout.pipe(stdout);
                return child.on('error', function(err) {
                    process.stderr.write('Failed to execute ' + err + '\n');
                    return firstChild.kill();
                });
            };
            currentCommand = split[0];
            args = currentCommand.split(' ');
            cmd = args.shift();
            opt = {
                encoding: 'utf8',
                shell: true
            };
            firstChild = previousChild = this.child = childp.spawn(cmd, args, opt);
            for (i = j = 1, ref1 = split.length; 1 <= ref1 ? j < ref1 : j > ref1; i = 1 <= ref1 ? ++j : --j) {
                currentCommand = split[i].trim();
                args = currentCommand.split(' ');
                cmd = args.shift();
                this.child = childp.spawn(cmd, args, opt);
                pipe(previousChild, this.child.stdin, process.stderr);
                previousChild = this.child;
            }
            this.child.stdout.on('data', this.onStdOut);
            this.child.stderr.on('data', this.onStdErr);
            this.child.on('close', (function(_this) {
                return function(code) {
                    firstChild.kill();
                    return _this.onExit(code);
                };
            })(this));
        } else {
            this.child = childp.exec(this.cmd, {
                shell: true
            });
            this.child.stdout.on('data', this.onStdOut);
            this.child.stderr.on('data', this.onStdErr);
            this.child.on('close', this.onExit);
        }
        return true;
    };

    Shell.prototype.handleCancel = function() {
        if (!this.child) {
            return 'unhandled';
        }
        psTree(this.child.pid, (function(_this) {
            return function(err, children) {
                var arg, j, len, results;
                args = children.map(function(p) {
                    return p.PID;
                });
                args.unshift(_this.child.pid);
                args.reverse();
                _this.child.kill();
                results = [];
                for (j = 0, len = args.length; j < len; j++) {
                    arg = args[j];
                    results.push(klog(arg, wxw('terminate', arg)));
                }
                return results;
            };
        })(this));
        return true;
    };

    Shell.prototype.onExit = function(code) {
        var killed;
        killed = this.child.killed;
        delete this.child;
        if (code === 0 || killed || this.fallback()) {
            return setImmediate(this.onDone);
        } else {
            this.term.failMeta(this.lastMeta);
            if (!/is not recognized/.test(this.errorText)) {
                this.editor.appendOutput('\n' + this.errorText);
            }
            return this.dequeue('fail');
        }
    };

    Shell.prototype.fallback = function() {
        if (this.lastMeta.fallback) {
            klog('fallback', this.lastMeta.fallback);
            this.enqueue({
                cmd: this.lastMeta.fallback,
                updateMeta: true,
                updateInput: true
            });
            delete this.lastMeta.fallback;
            return true;
        }
        return this.chdir.onFallback(this.cmd);
    };

    Shell.prototype.onDone = function(lastCode) {
        if (lastCode !== 'fail' && (this.lastMeta != null)) {
            post.emit('cmd', this.lastMeta.cmd, this.lastMeta.cwd);
            this.term.succMeta(this.lastMeta);
        }
        if (empty(this.queue) && empty(this.inputQueue)) {
            return this.term.pwd();
        } else {
            return this.dequeue();
        }
    };

    Shell.prototype.enqueue = function(arg1) {
        var cmd, front, ref1, ref2, ref3, ref4, updateInput, updateMeta;
        cmd = (ref1 = arg1.cmd) != null ? ref1 : '', front = (ref2 = arg1.front) != null ? ref2 : false, updateMeta = (ref3 = arg1.updateMeta) != null ? ref3 : false, updateInput = (ref4 = arg1.updateInput) != null ? ref4 : false;
        if (updateMeta) {
            this.lastMeta.cmd = cmd;
        }
        if (updateInput && this.lastMeta) {
            this.editor.replaceTextInLine(this.lastMeta[0], cmd);
            this.editor.meta.update(this.lastMeta);
        }
        cmd = cmd.replace(/\~/g, slash.home());
        if (front) {
            this.queue.unshift(cmd);
        } else {
            this.queue.push(cmd);
        }
        return cmd;
    };

    Shell.prototype.dequeue = function(lastCode) {
        var cmd;
        if (this.queue.length) {
            return this.executeCmd(this.queue.shift());
        } else if (this.inputQueue.length) {
            cmd = this.inputQueue.shift();
            this.editor.setInputText(cmd);
            return this.execute(cmd);
        } else {
            return this.onDone(lastCode);
        }
    };

    Shell.prototype.onStdOut = function(data) {
        if (data.replace == null) {
            data = data.toString('utf8');
        }
        if (data.slice(-1)[0] === '\n') {
            data = data.slice(0, +(data.length - 2) + 1 || 9e9);
        }
        this.editor.appendOutput(data);
        return this.editor.singleCursorAtEnd();
    };

    Shell.prototype.onStdErr = function(data) {
        return this.errorText += data;
    };

    return Shell;

})();

module.exports = Shell;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hlbGwuanMiLCJzb3VyY2VSb290IjoiLiIsInNvdXJjZXMiOlsiIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7Ozs7QUFBQSxJQUFBLHVHQUFBO0lBQUE7O0FBUUEsTUFBOEQsT0FBQSxDQUFRLEtBQVIsQ0FBOUQsRUFBRSxlQUFGLEVBQVEscUJBQVIsRUFBaUIsbUJBQWpCLEVBQXlCLG1CQUF6QixFQUFpQyxpQkFBakMsRUFBd0MsaUJBQXhDLEVBQStDLGVBQS9DLEVBQXFEOztBQUVyRCxPQUFBLEdBQVUsT0FBQSxDQUFRLFdBQVI7O0FBQ1YsS0FBQSxHQUFVLE9BQUEsQ0FBUSxTQUFSOztBQUNWLEtBQUEsR0FBVSxPQUFBLENBQVEsU0FBUjs7QUFDVixNQUFBLEdBQVUsT0FBQSxDQUFRLFNBQVI7O0FBQ1YsR0FBQSxHQUFVLE9BQUEsQ0FBUSxLQUFSOztBQUVKO0lBRUMsZUFBQyxJQUFEO1FBQUMsSUFBQyxDQUFBLE9BQUQ7Ozs7Ozs7Ozs7UUFFQSxJQUFDLENBQUEsTUFBRCxHQUFVLElBQUMsQ0FBQSxJQUFJLENBQUM7UUFDaEIsSUFBQyxDQUFBLEtBQUQsR0FBUyxJQUFJLEtBQUosQ0FBVSxJQUFWO1FBQ1QsSUFBQyxDQUFBLEtBQUQsR0FBUyxJQUFJLEtBQUosQ0FBVSxJQUFWO1FBQ1QsSUFBQyxDQUFBLEtBQUQsR0FBUztRQUNULElBQUMsQ0FBQSxVQUFELEdBQWM7SUFOZjs7b0JBUUgsRUFBQSxHQUFJLFNBQUMsR0FBRDtRQUVBLElBQUcsQ0FBSSxLQUFLLENBQUMsUUFBTixDQUFlLEdBQWYsRUFBb0IsT0FBTyxDQUFDLEdBQVIsQ0FBQSxDQUFwQixDQUFQO1lBQ0ksSUFBQyxDQUFBLFVBQUQsQ0FBWSxLQUFBLEdBQVEsR0FBcEI7bUJBQ0EsSUFBQyxDQUFBLE1BQU0sQ0FBQyxLQUFSLENBQUEsRUFGSjs7SUFGQTs7b0JBTUosVUFBQSxHQUFZLFNBQUMsR0FBRDtRQUVSLEdBQUEsR0FBTSxJQUFDLENBQUEsS0FBSyxDQUFDLFVBQVAs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QU8sb0JBQVA7WUFDSSxJQUFBLEdBQU8sSUFBSSxDQUFDLFFBQUwsQ0FBYyxNQUFkLEVBRFg7O1FBRUEsSUFBRyxJQUFLLFVBQUUsQ0FBQSxDQUFBLENBQVAsS0FBWSxJQUFmO1lBQ0ksSUFBQSxHQUFPLElBQUsseUNBRGhCOztRQUdBLElBQUMsQ0FBQSxNQUFNLENBQUMsWUFBUixDQUFxQixJQUFyQjtlQUNBLElBQUMsQ0FBQSxNQUFNLENBQUMsaUJBQVIsQ0FBQTtJQVJNOztvQkFVVixRQUFBLEdBQVUsU0FBQyxJQUFEO2VBRU4sSUFBQyxDQUFBLFNBQUQsSUFBYztJQUZSOzs7Ozs7QUFJZCxNQUFNLENBQUMsT0FBUCxHQUFpQiIsInNvdXJjZXNDb250ZW50IjpbIiMjI1xuIDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgIDAwMCAgICAgIDAwMCAgICBcbjAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAgICAwMDAgICAgXG4wMDAwMDAwICAgMDAwMDAwMDAwICAwMDAwMDAwICAgMDAwICAgICAgMDAwICAgIFxuICAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgICAgIDAwMCAgICBcbjAwMDAwMDAgICAwMDAgICAwMDAgIDAwMDAwMDAwICAwMDAwMDAwICAwMDAwMDAwXG4jIyNcblxueyBwb3N0LCBoaXN0b3J5LCBjaGlsZHAsIGtlcnJvciwgc2xhc2gsIGVtcHR5LCBhcmdzLCBrbG9nIH0gPSByZXF1aXJlICdreGsnXG5cbkhpc3RvcnkgPSByZXF1aXJlICcuL2hpc3RvcnknXG5BbGlhcyAgID0gcmVxdWlyZSAnLi9hbGlhcydcbkNoZGlyICAgPSByZXF1aXJlICcuL2NoZGlyJ1xucHNUcmVlICA9IHJlcXVpcmUgJ3BzLXRyZWUnXG53eHcgICAgID0gcmVxdWlyZSAnd3h3J1xuXG5jbGFzcyBTaGVsbFxuXG4gICAgQDogKEB0ZXJtKSAtPlxuICAgICAgICBcbiAgICAgICAgQGVkaXRvciA9IEB0ZXJtLmVkaXRvclxuICAgICAgICBAYWxpYXMgPSBuZXcgQWxpYXMgQFxuICAgICAgICBAY2hkaXIgPSBuZXcgQ2hkaXIgQFxuICAgICAgICBAcXVldWUgPSBbXVxuICAgICAgICBAaW5wdXRRdWV1ZSA9IFtdXG4gICAgICAgIFxuICAgIGNkOiAoZGlyKSA9PlxuICAgICAgICBcbiAgICAgICAgaWYgbm90IHNsYXNoLnNhbWVQYXRoIGRpciwgcHJvY2Vzcy5jd2QoKVxuICAgICAgICAgICAgQGV4ZWN1dGVDbWQgJ2NkICcgKyBkaXJcbiAgICAgICAgICAgIEBlZGl0b3IuZm9jdXMoKVxuICAgICAgICBcbiAgICBzdWJzdGl0dXRlOiAoY21kKSAtPlxuICAgICAgICBcbiAgICAgICAgY21kID0gQGFsaWFzLnN1YnN0aXR1dGUgY21kXG4gICAgICAgIGNtZCA9IGNtZC5yZXBsYWNlIC9cXH4vZywgc2xhc2guaG9tZSgpXG4gICAgICAgIGNtZFxuICAgICAgICAgICAgXG4gICAgIyAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDAwICAwMDAwMDAwMCAgXG4gICAgIyAwMDAgICAgICAgIDAwMCAwMDAgICAwMDAgICAgICAgMDAwICAgICAgIDAwMCAgIDAwMCAgICAgMDAwICAgICAwMDAgICAgICAgXG4gICAgIyAwMDAwMDAwICAgICAwMDAwMCAgICAwMDAwMDAwICAgMDAwICAgICAgIDAwMCAgIDAwMCAgICAgMDAwICAgICAwMDAwMDAwICAgXG4gICAgIyAwMDAgICAgICAgIDAwMCAwMDAgICAwMDAgICAgICAgMDAwICAgICAgIDAwMCAgIDAwMCAgICAgMDAwICAgICAwMDAgICAgICAgXG4gICAgIyAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgICAwMDAwMDAwICAgICAgMDAwICAgICAwMDAwMDAwMCAgXG4gICAgXG4gICAgZXhlY3V0ZTogKEBjbWQ6LCBmYWxsYmFjazopID0+XG4gICAgXG4gICAgICAgIEBjbWQgPz0gQGVkaXRvci5sYXN0TGluZSgpXG4gICAgICAgIEBjbWQgPSBAY21kLnRyaW0oKVxuICAgICAgICBcbiAgICAgICAgaWYgQGNoaWxkXG4gICAgICAgICAgICBAaW5wdXRRdWV1ZS5wdXNoIEBjbWRcbiAgICAgICAgICAgIEBlZGl0b3Iuc2V0SW5wdXRUZXh0ICcnXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgXG4gICAgICAgIEBlcnJvclRleHQgPSAnJ1xuICAgICAgICBcbiAgICAgICAgaWYgQGNtZCAhPSBoc3ViID0gSGlzdG9yeS5zdWJzdGl0dXRlIEBjbWRcbiAgICAgICAgICAgIEBjbWQgPSBoc3ViXG4gICAgICAgICAgICBAZWRpdG9yLnNldElucHV0VGV4dCBAY21kXG4gICAgICAgIFxuICAgICAgICBAZWRpdG9yLmFwcGVuZFRleHQgJydcbiAgICAgICAgQGVkaXRvci5zaW5nbGVDdXJzb3JBdEVuZCgpXG4gICAgICAgICAgICBcbiAgICAgICAgaWYgZW1wdHkgQGNtZFxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIFxuICAgICAgICBAdGVybS5oaXN0b3J5LnNoZWxsQ21kIEBjbWQgIyBtaWdodCByZXNldCBoaXN0b3J5IHBvaW50ZXIgdG8gbGFzdFxuXG4gICAgICAgIEBsYXN0TWV0YSA9IEB0ZXJtLmluc2VydENtZE1ldGEgQGVkaXRvci5udW1MaW5lcygpLTIgQGNtZFxuICAgICAgICBAbGFzdE1ldGEuY21kID0gQGNtZFxuICAgICAgICBAbGFzdE1ldGEuY3dkID0gcHJvY2Vzcy5jd2QoKVxuICAgICAgICBAbGFzdE1ldGEuZmFsbGJhY2sgPSBmYWxsYmFja1xuICAgICAgICBcbiAgICAgICAgQGV4ZWN1dGVDbWQgQHN1YnN0aXR1dGUgQGNtZFxuICAgICAgICAgICAgICAgIFxuICAgICMgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgICAwMDAwMDAwICAgICAgICAwMDAwMDAwICAwMCAgICAgMDAgIDAwMDAwMDAgICAgXG4gICAgIyAwMDAgICAgICAgIDAwMCAwMDAgICAwMDAgICAgICAgMDAwICAgICAgICAgICAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICBcbiAgICAjIDAwMDAwMDAgICAgIDAwMDAwICAgIDAwMDAwMDAgICAwMDAgICAgICAgICAgICAwMDAgICAgICAgMDAwMDAwMDAwICAwMDAgICAwMDAgIFxuICAgICMgMDAwICAgICAgICAwMDAgMDAwICAgMDAwICAgICAgIDAwMCAgICAgICAgICAgIDAwMCAgICAgICAwMDAgMCAwMDAgIDAwMCAgIDAwMCAgXG4gICAgIyAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgICAgICAgIDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMCAgICBcbiAgICBcbiAgICBleGVjdXRlQ21kOiAoQGNtZCkgPT5cbiAgICAgICAgXG4gICAgICAgIHNwbGl0ID0gQGNtZC5zcGxpdCAnJiYnXG4gICAgICAgIGlmIHNwbGl0Lmxlbmd0aCA+IDFcbiAgICAgICAgICAgIEBjbWQgPSBzcGxpdFswXS50cmltKClcbiAgICAgICAgICAgIEBxdWV1ZSA9IEBxdWV1ZS5jb25jYXQgc3BsaXRbMS4uXVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICBAY21kID0gQGNtZC50cmltKClcbiAgICAgICAgXG4gICAgICAgIGlmIGVtcHR5IEBjbWRcbiAgICAgICAgICAgIEBkZXF1ZXVlKClcbiAgICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgIFxuICAgICAgICBpZiBAYWxpYXMub25Db21tYW5kIEBjbWRcbiAgICAgICAgICAgIEBkZXF1ZXVlKClcbiAgICAgICAgICAgIHJldHVybiB0cnVlXG5cbiAgICAgICAgaWYgQGNoZGlyLm9uQ29tbWFuZCBAY21kXG4gICAgICAgICAgICBAZGVxdWV1ZSgpXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICAgICAgXG4gICAgICAgICMga2xvZyAnc2hlbGxDbWQnIEBjbWQgICAgXG4gICAgICAgIEBzaGVsbENtZCBAY21kXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICMgIDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgIDAwMCAgICAgIDAwMCAgICAgICAgICAgMDAwMDAwMCAgMDAgICAgIDAwICAwMDAwMDAwICAgIFxuICAgICMgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgICAgIDAwMCAgICAgICAgICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIFxuICAgICMgMDAwMDAwMCAgIDAwMDAwMDAwMCAgMDAwMDAwMCAgIDAwMCAgICAgIDAwMCAgICAgICAgICAwMDAgICAgICAgMDAwMDAwMDAwICAwMDAgICAwMDAgIFxuICAgICMgICAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgICAgIDAwMCAgICAgICAgICAwMDAgICAgICAgMDAwIDAgMDAwICAwMDAgICAwMDAgIFxuICAgICMgMDAwMDAwMCAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgIDAwMDAwMDAgIDAwMDAwMDAgICAgICAgMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwICAgIFxuICAgIFxuICAgIHNoZWxsQ21kOiAoQGNtZCkgPT5cbiAgICAgICAgICAgIFxuICAgICAgICBzcGxpdCA9IEBjbWQuc3BsaXQgJ3wnXG4gICAgICAgIFxuICAgICAgICBpZiBzcGxpdC5sZW5ndGggPiAxXG4gICAgICAgICAgICBcbiAgICAgICAgICAgICMgMDAwMDAwMDAgICAwMDAgIDAwMDAwMDAwICAgMDAwMDAwMDAgIFxuICAgICAgICAgICAgIyAwMDAgICAwMDAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgXG4gICAgICAgICAgICAjIDAwMDAwMDAwICAgMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgICBcbiAgICAgICAgICAgICMgMDAwICAgICAgICAwMDAgIDAwMCAgICAgICAgMDAwICAgICAgIFxuICAgICAgICAgICAgIyAwMDAgICAgICAgIDAwMCAgMDAwICAgICAgICAwMDAwMDAwMCAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHBpcGUgPSAoY2hpbGQsIHN0ZG91dCwgc3RkZXJyKSAtPlxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNoaWxkLnN0ZGluLm9uICdlcnJvcicgKGVycikgLT4gc3RkZXJyLndyaXRlICdzdGRpbiBlcnJvcicgKyBlcnIgKyAnXFxuJ1xuICAgICAgICAgICAgICAgIGNoaWxkLnN0ZGVyci5vbiAnZGF0YScgKGRhdGEpIC0+IGlmIG5vdCAvXmV4ZWN2cFxcKFxcKS8udGVzdCBkYXRhIHRoZW4gc3RkZXJyLndyaXRlIGRhdGFcbiAgICAgICAgICAgICAgICBjaGlsZC5zdGRvdXQucGlwZSBzdGRvdXRcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNoaWxkLm9uICdlcnJvcicgKGVycikgLT5cbiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5zdGRlcnIud3JpdGUgJ0ZhaWxlZCB0byBleGVjdXRlICcgKyBlcnIgKyAnXFxuJ1xuICAgICAgICAgICAgICAgICAgICBmaXJzdENoaWxkLmtpbGwoKVxuXG4gICAgICAgICAgICBjdXJyZW50Q29tbWFuZCA9IHNwbGl0WzBdXG4gICAgICAgICAgICBhcmdzID0gY3VycmVudENvbW1hbmQuc3BsaXQgJyAnXG4gICAgICAgICAgICBjbWQgPSBhcmdzLnNoaWZ0KClcbiAgICAgICAgICAgIG9wdCA9IGVuY29kaW5nOid1dGY4JyBzaGVsbDp0cnVlXG4gICAgICAgICAgICBmaXJzdENoaWxkID0gcHJldmlvdXNDaGlsZCA9IEBjaGlsZCA9IGNoaWxkcC5zcGF3biBjbWQsIGFyZ3MsIG9wdFxuICAgICAgICBcbiAgICAgICAgICAgIGZvciBpIGluIFsxLi4uc3BsaXQubGVuZ3RoXVxuICAgICAgICAgICAgICAgIGN1cnJlbnRDb21tYW5kID0gc3BsaXRbaV0udHJpbSgpXG4gICAgICAgICAgICAgICAgYXJncyA9IGN1cnJlbnRDb21tYW5kLnNwbGl0ICcgJ1xuICAgICAgICAgICAgICAgIGNtZCA9IGFyZ3Muc2hpZnQoKVxuICAgICAgICAgICAgICAgIEBjaGlsZCA9IGNoaWxkcC5zcGF3biBjbWQsIGFyZ3MsIG9wdFxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHBpcGUgcHJldmlvdXNDaGlsZCwgQGNoaWxkLnN0ZGluLCBwcm9jZXNzLnN0ZGVyclxuICAgICAgICBcbiAgICAgICAgICAgICAgICBwcmV2aW91c0NoaWxkID0gQGNoaWxkXG4gICAgICAgIFxuICAgICAgICAgICAgQGNoaWxkLnN0ZG91dC5vbiAnZGF0YScgQG9uU3RkT3V0XG4gICAgICAgICAgICBAY2hpbGQuc3RkZXJyLm9uICdkYXRhJyBAb25TdGRFcnJcbiAgICAgICAgXG4gICAgICAgICAgICBAY2hpbGQub24gJ2Nsb3NlJyAoY29kZSkgPT5cbiAgICAgICAgICAgICAgICBmaXJzdENoaWxkLmtpbGwoKVxuICAgICAgICAgICAgICAgIEBvbkV4aXQgY29kZVxuICAgICAgICBlbHNlXG4gICAgICAgIFxuICAgICAgICAgICAgIyAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgIFxuICAgICAgICAgICAgIyAwMDAgICAgICAgIDAwMCAwMDAgICAwMDAgICAgICAgMDAwICAgICAgIFxuICAgICAgICAgICAgIyAwMDAwMDAwICAgICAwMDAwMCAgICAwMDAwMDAwICAgMDAwICAgICAgIFxuICAgICAgICAgICAgIyAwMDAgICAgICAgIDAwMCAwMDAgICAwMDAgICAgICAgMDAwICAgICAgIFxuICAgICAgICAgICAgIyAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBAY2hpbGQgPSBjaGlsZHAuZXhlYyBAY21kLCBzaGVsbDp0cnVlXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIEBjaGlsZC5zdGRvdXQub24gJ2RhdGEnICBAb25TdGRPdXRcbiAgICAgICAgICAgIEBjaGlsZC5zdGRlcnIub24gJ2RhdGEnICBAb25TdGRFcnJcbiAgICAgICAgICAgIEBjaGlsZC5vbiAgICAgICAgJ2Nsb3NlJyBAb25FeGl0XG4gICAgICAgICAgICBcbiAgICAgICAgdHJ1ZVxuICAgICAgICBcbiAgICAjICAwMDAwMDAwICAgMDAwMDAwMCAgIDAwMCAgIDAwMCAgIDAwMDAwMDAgIDAwMDAwMDAwICAwMDAgICAgICBcbiAgICAjIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMDAgIDAwMCAgMDAwICAgICAgIDAwMCAgICAgICAwMDAgICAgICBcbiAgICAjIDAwMCAgICAgICAwMDAwMDAwMDAgIDAwMCAwIDAwMCAgMDAwICAgICAgIDAwMDAwMDAgICAwMDAgICAgICBcbiAgICAjIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgMDAwMCAgMDAwICAgICAgIDAwMCAgICAgICAwMDAgICAgICBcbiAgICAjICAwMDAwMDAwICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgIDAwMDAwMDAgIDAwMDAwMDAwICAwMDAwMDAwICBcbiAgICBcbiAgICBoYW5kbGVDYW5jZWw6IC0+XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gJ3VuaGFuZGxlZCcgaWYgbm90IEBjaGlsZFxuICAgICAgICBcbiAgICAgICAgcHNUcmVlIEBjaGlsZC5waWQsIChlcnIsIGNoaWxkcmVuKSA9PlxuICAgICAgICAgICAgXG4gICAgICAgICAgICBhcmdzID0gY2hpbGRyZW4ubWFwIChwKSAtPiBwLlBJRFxuICAgICAgICAgICAgYXJncy51bnNoaWZ0IEBjaGlsZC5waWRcbiAgICAgICAgICAgIGFyZ3MucmV2ZXJzZSgpXG4gICAgICAgICAgICBAY2hpbGQua2lsbCgpXG4gICAgICAgICAgICBmb3IgYXJnIGluIGFyZ3NcbiAgICAgICAgICAgICAgICBrbG9nIGFyZywgd3h3ICd0ZXJtaW5hdGUnIGFyZ1xuICAgICAgICB0cnVlXG4gICAgICAgIFxuICAgICMgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwICAwMDAwMDAwMDAgIFxuICAgICMgMDAwICAgICAgICAwMDAgMDAwICAgMDAwICAgICAwMDAgICAgIFxuICAgICMgMDAwMDAwMCAgICAgMDAwMDAgICAgMDAwICAgICAwMDAgICAgIFxuICAgICMgMDAwICAgICAgICAwMDAgMDAwICAgMDAwICAgICAwMDAgICAgIFxuICAgICMgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAwMDAgICAgIFxuICAgICAgICBcbiAgICBvbkV4aXQ6IChjb2RlKSA9PlxuXG4gICAgICAgIGtpbGxlZCA9IEBjaGlsZC5raWxsZWRcbiAgICAgICAgIyBrbG9nICdvbkV4aXQnIEBjaGlsZC5waWQsIGtpbGxlZCBhbmQgJ2tpbGxlZCcgb3IgY29kZVxuICAgICAgICBkZWxldGUgQGNoaWxkXG4gICAgICAgIGlmIGNvZGUgPT0gMCBvciBraWxsZWQgb3IgQGZhbGxiYWNrKClcbiAgICAgICAgICAgIHNldEltbWVkaWF0ZSBAb25Eb25lXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIEB0ZXJtLmZhaWxNZXRhIEBsYXN0TWV0YVxuICAgICAgICAgICAgaWYgbm90IC9pcyBub3QgcmVjb2duaXplZC8udGVzdCBAZXJyb3JUZXh0XG4gICAgICAgICAgICAgICAgQGVkaXRvci5hcHBlbmRPdXRwdXQgJ1xcbicrQGVycm9yVGV4dFxuICAgICAgICAgICAgQGRlcXVldWUgJ2ZhaWwnXG4gICAgICAgICAgXG4gICAgIyAwMDAwMDAwMCAgIDAwMDAwMDAgICAwMDAgICAgICAwMDAgICAgICAwMDAwMDAwICAgICAwMDAwMDAwICAgIDAwMDAwMDAgIDAwMCAgIDAwMCAgXG4gICAgIyAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgICAgICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgMDAwICAgXG4gICAgIyAwMDAwMDAgICAgMDAwMDAwMDAwICAwMDAgICAgICAwMDAgICAgICAwMDAwMDAwICAgIDAwMDAwMDAwMCAgMDAwICAgICAgIDAwMDAwMDAgICAgXG4gICAgIyAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgICAgICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgMDAwICAgXG4gICAgIyAwMDAgICAgICAgMDAwICAgMDAwICAwMDAwMDAwICAwMDAwMDAwICAwMDAwMDAwICAgIDAwMCAgIDAwMCAgIDAwMDAwMDAgIDAwMCAgIDAwMCAgXG4gICAgXG4gICAgZmFsbGJhY2s6IC0+XG4gICAgICAgIFxuICAgICAgICBpZiBAbGFzdE1ldGEuZmFsbGJhY2tcbiAgICAgICAgICAgIGtsb2cgJ2ZhbGxiYWNrJyBAbGFzdE1ldGEuZmFsbGJhY2tcbiAgICAgICAgICAgIEBlbnF1ZXVlIGNtZDpAbGFzdE1ldGEuZmFsbGJhY2ssIHVwZGF0ZU1ldGE6dHJ1ZSwgdXBkYXRlSW5wdXQ6dHJ1ZVxuICAgICAgICAgICAgZGVsZXRlIEBsYXN0TWV0YS5mYWxsYmFja1xuICAgICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgXG4gICAgICAgIEBjaGRpci5vbkZhbGxiYWNrIEBjbWRcbiAgICAgICAgICAgIFxuICAgICMgMDAwMDAwMCAgICAgMDAwMDAwMCAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgIFxuICAgICMgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMDAgIDAwMCAgMDAwICAgICAgIFxuICAgICMgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAwIDAwMCAgMDAwMDAwMCAgIFxuICAgICMgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgMDAwMCAgMDAwICAgICAgIFxuICAgICMgMDAwMDAwMCAgICAgMDAwMDAwMCAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgIFxuICAgIFxuICAgIG9uRG9uZTogKGxhc3RDb2RlKSA9PlxuXG4gICAgICAgIGlmIGxhc3RDb2RlICE9ICdmYWlsJyBhbmQgQGxhc3RNZXRhP1xuICAgICAgICAgICAgcG9zdC5lbWl0ICdjbWQnIEBsYXN0TWV0YS5jbWQsIEBsYXN0TWV0YS5jd2QgIyBpbnNlcnQgaW50byBnbG9iYWwgaGlzdG9yeVxuICAgICAgICAgICAgQHRlcm0uc3VjY01ldGEgQGxhc3RNZXRhXG4gICAgICAgIGlmIGVtcHR5KEBxdWV1ZSkgYW5kIGVtcHR5KEBpbnB1dFF1ZXVlKVxuICAgICAgICAgICAgQHRlcm0ucHdkKClcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgQGRlcXVldWUoKVxuICAgICAgICAgICBcbiAgICAjIDAwMDAwMDAwICAwMDAgICAwMDAgICAwMDAwMDAwICAgMDAwICAgMDAwICAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgXG4gICAgIyAwMDAgICAgICAgMDAwMCAgMDAwICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgICAgIFxuICAgICMgMDAwMDAwMCAgIDAwMCAwIDAwMCAgMDAwIDAwIDAwICAwMDAgICAwMDAgIDAwMDAwMDAgICAwMDAgICAwMDAgIDAwMDAwMDAgICBcbiAgICAjIDAwMCAgICAgICAwMDAgIDAwMDAgIDAwMCAwMDAwICAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAgXG4gICAgIyAwMDAwMDAwMCAgMDAwICAgMDAwICAgMDAwMDAgMDAgICAwMDAwMDAwICAgMDAwMDAwMDAgICAwMDAwMDAwICAgMDAwMDAwMDAgIFxuICAgIFxuICAgIGVucXVldWU6IChjbWQ6JycgZnJvbnQ6ZmFsc2UgdXBkYXRlTWV0YTpmYWxzZSB1cGRhdGVJbnB1dDpmYWxzZSkgLT4gXG4gICAgXG4gICAgICAgIGlmIHVwZGF0ZU1ldGFcbiAgICAgICAgICAgIEBsYXN0TWV0YS5jbWQgPSBjbWRcbiAgICAgICAgICAgIFxuICAgICAgICBpZiB1cGRhdGVJbnB1dCBhbmQgQGxhc3RNZXRhXG4gICAgICAgICAgICBAZWRpdG9yLnJlcGxhY2VUZXh0SW5MaW5lIEBsYXN0TWV0YVswXSwgY21kXG4gICAgICAgICAgICBAZWRpdG9yLm1ldGEudXBkYXRlIEBsYXN0TWV0YVxuICAgICAgICAgICAgXG4gICAgICAgIGNtZCA9IGNtZC5yZXBsYWNlIC9cXH4vZywgc2xhc2guaG9tZSgpXG4gICAgICAgIFxuICAgICAgICBpZiBmcm9udFxuICAgICAgICAgICAgQHF1ZXVlLnVuc2hpZnQgY21kXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIEBxdWV1ZS5wdXNoIGNtZFxuICAgICAgICBjbWRcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgIyAwMDAwMDAwICAgIDAwMDAwMDAwICAgMDAwMDAwMCAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMDAgIFxuICAgICMgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgICAgICBcbiAgICAjIDAwMCAgIDAwMCAgMDAwMDAwMCAgIDAwMCAwMCAwMCAgMDAwICAgMDAwICAwMDAwMDAwICAgMDAwICAgMDAwICAwMDAwMDAwICAgXG4gICAgIyAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgMDAwMCAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgICAgIFxuICAgICMgMDAwMDAwMCAgICAwMDAwMDAwMCAgIDAwMDAwIDAwICAgMDAwMDAwMCAgIDAwMDAwMDAwICAgMDAwMDAwMCAgIDAwMDAwMDAwICBcbiAgICBcbiAgICBkZXF1ZXVlOiAobGFzdENvZGUpID0+XG4gXG4gICAgICAgIGlmIEBxdWV1ZS5sZW5ndGhcbiAgICAgICAgICAgIEBleGVjdXRlQ21kIEBxdWV1ZS5zaGlmdCgpXG4gICAgICAgIGVsc2UgaWYgQGlucHV0UXVldWUubGVuZ3RoXG4gICAgICAgICAgICBjbWQgPSBAaW5wdXRRdWV1ZS5zaGlmdCgpXG4gICAgICAgICAgICBAZWRpdG9yLnNldElucHV0VGV4dCBjbWRcbiAgICAgICAgICAgIEBleGVjdXRlIGNtZFxuICAgICAgICBlbHNlXG4gICAgICAgICAgICBAb25Eb25lIGxhc3RDb2RlXG4gICAgICAgIFxuICAgICMgIDAwMDAwMDAgIDAwMDAwMDAwMCAgMDAwMDAwMCAgICBcbiAgICAjIDAwMCAgICAgICAgICAwMDAgICAgIDAwMCAgIDAwMCAgXG4gICAgIyAwMDAwMDAwICAgICAgMDAwICAgICAwMDAgICAwMDAgIFxuICAgICMgICAgICAwMDAgICAgIDAwMCAgICAgMDAwICAgMDAwICBcbiAgICAjIDAwMDAwMDAgICAgICAwMDAgICAgIDAwMDAwMDAgICAgXG4gICAgXG4gICAgb25TdGRPdXQ6IChkYXRhKSA9PlxuICAgICAgICBcbiAgICAgICAgaWYgbm90IGRhdGEucmVwbGFjZT9cbiAgICAgICAgICAgIGRhdGEgPSBkYXRhLnRvU3RyaW5nICd1dGY4J1xuICAgICAgICBpZiBkYXRhWy0xXSA9PSAnXFxuJ1xuICAgICAgICAgICAgZGF0YSA9IGRhdGFbMC4uZGF0YS5sZW5ndGgtMl1cbiAgICAgICAgICAgIFxuICAgICAgICBAZWRpdG9yLmFwcGVuZE91dHB1dCBkYXRhXG4gICAgICAgIEBlZGl0b3Iuc2luZ2xlQ3Vyc29yQXRFbmQoKVxuXG4gICAgb25TdGRFcnI6IChkYXRhKSA9PlxuXG4gICAgICAgIEBlcnJvclRleHQgKz0gZGF0YVxuICAgICAgICBcbm1vZHVsZS5leHBvcnRzID0gU2hlbGxcbiJdfQ==
//# sourceURL=../coffee/shell.coffee